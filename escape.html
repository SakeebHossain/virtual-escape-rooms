<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HALSEY: THE ESCAPE</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --accent: #8e44ad;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
            overflow: hidden;
        }

        #game-container {
            width: 90%;
            max-width: 650px;
            padding: 40px;
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            background: #0d0d0d;
        }

        /* Inventory UI */
        #inventory-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        .inv-item {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: #1a1a1a;
            font-size: 1.2rem;
        }
        .inv-item:hover { border-color: var(--accent); }

        /* Modal for Cipher */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #modal img { max-width: 80%; border: 2px solid var(--accent); }

        button {
            background: transparent;
            color: var(--text-color);
            border: 1px solid var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 10px;
            transition: 0.3s;
        }
        button:hover { background: var(--text-color); color: var(--bg-color); }
        button:disabled { border-color: #333; color: #333; cursor: not-allowed; }

        input {
            background: #1a1a1a;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            margin: 5px;
            text-align: center;
        }

        .solved-text { color: var(--accent); font-weight: bold; font-size: 2.5em; margin: 10px 0; }
        .beaker { display: inline-block; width: 40px; height: 60px; border: 2px solid #ccc; border-top: none; border-radius: 0 0 8px 8px; margin: 5px; }
        .statue-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .muse { cursor: pointer; transition: transform 0.3s; font-size: 2rem; }
        .darkness { background: black; color: #222; padding: 50px; }
    </style>
</head>
<body>



<div id="modal" onclick="this.style.display='none'">
    <div style="text-align:center;">
        <p>CAESAR CIPHER</p>
        <img src="https://via.placeholder.com/400x400?text=CAESAR+CIPHER+IMAGE" alt="Cipher">
        <p style="font-size:0.8em;">(Click anywhere to close)</p>
    </div>
</div>

<div id="game-container">
    <div id="inventory-bar"></div>
    <div id="content"></div>
</div>

<script>
    let state = {
        currentPage: 'home',
        discovered: ['door5'],
        solved: [], 
        inventory: [], // 'matches', 'cipher', 'key'
        chamberUnlocked: false,
        torchesLit: false,
        statues: [0, 0, 0, 0],
        beakers: []
    };

    // --- Persistence ---
    const loadProgress = () => {
        const saved = localStorage.getItem('halsey_escape_v2');
        if (saved) state = JSON.parse(saved);
    };
    const save = () => {
        // Logic check: If Door 3, 4, 6, 7 are solved, grant the key automatically
        const required = ['library', 'game', 'chem', 'statue'];
        const hasAll = required.every(r => state.solved.includes(r));
        if (hasAll && !state.inventory.includes('key')) {
            state.inventory.push('key');
            alert("With the four rooms complete, a golden key materializes in your hand!");
        }
        localStorage.setItem('halsey_escape_v2', JSON.stringify(state));
        updateInventoryUI();
    };

    const resetGame = () => {
        if(confirm("Are you sure you want to reset all progress?")) {
            localStorage.removeItem('halsey_escape_v2');
            location.reload();
        }
    };

    // --- Inventory UI ---
    const updateInventoryUI = () => {
        const bar = document.getElementById('inventory-bar');
        bar.innerHTML = '';
        state.inventory.forEach(item => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            if(item === 'matches') { div.innerText = 'ðŸ”¥'; div.onclick = () => alert("A box of wooden matches."); }
            if(item === 'cipher') { div.innerText = 'ðŸ“œ'; div.onclick = () => document.getElementById('modal').style.display='flex'; }
            if(item === 'key') { div.innerText = 'ðŸ”‘'; div.onclick = () => alert("The Master Key to the Old Man's Chambers."); }
            bar.appendChild(div);
        });
    };

    // --- Navigation ---
    const goTo = (pg) => { state.currentPage = pg; render(); };

    function render() {
        const content = document.getElementById('content');
        content.innerHTML = '';
        window.onkeydown = null; // Clean up listeners

        switch(state.currentPage) {
            case 'home':
                content.innerHTML = `<h1>HALSEY</h1><p>Escape the Old Man's Castle</p><button onclick="goTo('intro')">Begin</button>`;
                break;
            case 'intro':
                content.innerHTML = `<h2>THE CAPTURE</h2><p>Taken to the high chambers... escape is the only option.</p><button onclick="goTo('cell')">Start</button>`;
                break;
            case 'hallway':
                renderHallway(content);
                break;
            case 'cell':
                renderCell(content);
                break;
            case 'door1':
                renderDoor1(content);
                break;
            case 'door2':
                renderDoor2(content);
                break;
            case 'door3':
                renderLibrary(content);
                break;
            case 'door4':
                renderGameRoom(content);
                break;
            case 'door6':
                renderChemistry(content);
                break;
            case 'door7':
                renderStatueRoom(content);
                break;
            case 'door8':
                renderSupplyCloset(content);
                break;
        }
        save();
    }

    // --- Page Logic Functions ---

    function renderHallway(container) {
        const doors = [
            { id: 'door1', name: 'Main Door' },
            { id: 'door2', name: "Old Man's Chambers" },
            { id: 'door3', name: 'Library' },
            { id: 'door4', name: 'Game Room' },
            { id: 'door5', name: 'Cell' },
            { id: 'door6', name: 'Chemistry Room' },
            { id: 'door7', name: 'Statue Room' },
            { id: 'door8', name: 'Supply Closet' }
        ];
        
        container.innerHTML = `<h2>THE HALLWAY</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left;"></div><br><button onclick="resetGame()" style="font-size:0.6em; margin-top:50px;">Reset Progress</button>`;
        const grid = container.querySelector('div');
        
        doors.forEach(d => {
            const isDiscovered = state.discovered.includes(d.id) || d.id === 'door5';
            const label = isDiscovered ? `Door ${d.id.replace('door','')} (${d.name})` : `Door ${d.id.replace('door','')}`;
            const link = document.createElement('p');
            link.innerHTML = `<a href="#" style="color:white" onclick="goTo('${d.id === 'door5' ? 'cell' : d.id}')">${label}</a>`;
            grid.appendChild(link);
        });
    }

    function renderCell(container) {
        if (state.solved.includes('cell')) {
            container.innerHTML = `<h2>THE CELL</h2><div class="solved-text">P</div><button onclick="goTo('hallway')">Return</button>`;
            return;
        }
        let inputs = [];
        container.innerHTML = `<h2>THE CELL</h2><p>Tracklist Note Found...</p><pre style="font-size:0.7em; background:#111;">1. Castle\n2. "Hold Me ____"\n3. "New Americana"\n4. "Drive"\n4. "Drive"\n...</pre><div id="cd" style="height:30px; border:1px solid #444; margin:10px;"></div><button onclick="checkCell()">SUBMIT</button><button onclick="goTo('cell')">RESET</button>`;
        window.onkeydown = (e) => { 
            inputs.push(e.key); 
            document.getElementById('cd').innerText = inputs.join(' '); 
        };
        window.checkCell = () => {
            if (inputs.slice(-3).join(',') === "ArrowDown,ArrowDown,Control") { state.solved.push('cell'); render(); }
            else { alert("Nothing."); inputs=[]; render(); }
        };
    }

function renderSupplyCloset(container) {
        state.discovered.push('door8');

        // Check if the player already has the item
        if (state.inventory.includes('matches')) {
            container.innerHTML = `
                <h2>SUPPLY CLOSET</h2>
                <p>The narrow room is quiet now, smelling of cedar and old floor wax. The shelf where the matches sat is now empty.</p>
                <button onclick="goTo('hallway')">Return to Hallway</button>`;
            return;
        }

        // Render the unsolved state
        container.innerHTML = `
            <h2>SUPPLY CLOSET</h2>
            <p>This cramped space is packed with cleaning supplies and forgotten linens. Tucked behind a heavy bucket, you find a box of matches, but it is stuck.</p>
            
            <div style="margin: 20px 0;">
                <img src="images/matches.png" alt="Matchstick Puzzle" style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--md-outline);">
            </div>

            <p>There is at least one number above 50000 you can make by moving two matches. What is one of those numbers?</p>
            
            <input id="sc-in" type="number" placeholder="Enter the number">
            <br>
            <button onclick="checkSC()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;

        // Puzzle logic
        window.checkSC = () => {
            const val = document.getElementById('sc-in').value;
            // Accepts both 51181 and 81151 based on your requirements
            if(val === '51181' || val === '81151') {
                state.inventory.push('matches');
                alert("THe box of matches become unstuck, so you take it. Might come in handy later.");
                render(); // Re-render to show the "taken" state
            } else { 
                alert("The matchbox remains stuck. Maybe that's not the right number."); 
            }
        };
    }

    function renderLibrary(container) {
        state.discovered.push('door3');
        if (!state.torchesLit) {
            container.innerHTML = `<div class="darkness">It is pitch black. You can see the faint outline of torches on the wall.</div>
            ${state.inventory.includes('matches') ? '<button onclick="state.torchesLit=true; render();">Light Torches</button>' : '<p>If only you had a way to light them...</p>'}
            <button onclick="goTo('hallway')">Leave</button>`;
            return;
        }
        if (state.solved.includes('library')) {
            container.innerHTML = `<h2>LIBRARY</h2><div class="solved-text">DD</div><button onclick="goTo('hallway')">Return</button>`;
            return;
        }
        container.innerHTML = `<h2>LIBRARY</h2><p>MM/DD for: Arcade, After Concert, Ferris Wheel</p><input id="l1" placeholder="_ _ / _ _"><input id="l2" placeholder="_ _ / _ _"><input id="l3" placeholder="_ _ / _ _"><br><button onclick="checkLib()">SUBMIT</button><button onclick="goTo('hallway')">Return</button>`;
        window.checkLib = () => {
            if(document.getElementById('l1').value==='12/23' && document.getElementById('l2').value==='01/10' && document.getElementById('l3').value==='01/31') {
                state.solved.push('library'); render();
            } else alert("Locked.");
        };
    }

    function renderDoor2(container) {
        state.discovered.push('door2');
        if(!state.chamberUnlocked) {
            container.innerHTML = `<h2>OLD MAN'S CHAMBERS</h2><p>Locked keyhole.</p>${state.inventory.includes('key') ? '<button onclick="state.chamberUnlocked=true; render();">Use Golden Key</button>' : '<p>You need the Golden Key. Finish the other rooms.</p>'}<button onclick="goTo('hallway')">Return</button>`;
        } else {
            if(!state.inventory.includes('cipher')) state.inventory.push('cipher');
            container.innerHTML = `<h2>INSIDE CHAMBERS</h2><p>You rummage the desk and find the Caesar Cipher!</p><button onclick="goTo('hallway')">Return</button>`;
        }
    }

    function renderDoor1(container) {
        state.discovered.push('door1');
        container.innerHTML = `<h2>MAIN DOOR</h2><input id="final" placeholder="CODE"><button onclick="checkFinal()">ESCAPE</button><br><button onclick="goTo('hallway')">Return</button>`;
        window.checkFinal = () => {
            if(document.getElementById('final').value.toUpperCase() === 'MATCHA') {
                alert("THE DOOR SWINGS OPEN! YOU ARE FREE!");
                resetGame();
            } else alert("It won't budge.");
        };
    }

function renderGameRoom(c) {
        state.discovered.push('door4');
        if(state.solved.includes('game')) { 
            c.innerHTML = `<h2>GAME ROOM</h2><div class="solved-text">W</div><button onclick="goTo('hallway')">Return</button>`; 
            return; 
        }
        
        c.innerHTML = `
            <h2>GAME ROOM</h2>
            <p>A chill hangs in the air of this enchanted parlor, filled with interesting knicknacks and games. In the center of the room, a legendary board game sits atop a pedestal, its pieces seemingly moving on their own as if waiting for something.</p>
            
            <div style="margin-bottom: 20px;">
                <img src="images/samurai-edited.png" alt="Samurai" style="max-width: 100%; height: auto; border-radius: 12px; border: 1px solid var(--md-outline);">
            </div>
            
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
                <svg width="45" height="45" viewBox="0 0 100 100">
                    <rect x="15" y="15" width="70" height="70" fill="#2196f3" />
                </svg>

                <svg width="45" height="45" viewBox="0 0 100 100" 
                     style="cursor: pointer;" 
                     onclick="window.open('https://wyrmbergames.wordpress.com/the-games-n-z/samurai-the-card-game/#:~:text=Victory%20Conditions,winning%20markers%2C%20wins.', '_blank')">
                    <circle cx="50" cy="50" r="40" fill="#f44336" />
                </svg>

                <svg width="45" height="45" viewBox="0 0 100 100">
                    <polygon points="50,15 90,85 10,85" fill="#8e44ad" />
                </svg>
            </div>

            <input id="gi" type="number" placeholder="Enter Code">
            <br>
            <button onclick="checkGameMove()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return</button>
        `;

        window.checkGameMove = () => {
            const val = document.getElementById('gi').value;
            if(val === '102') {
                state.solved.push('game');
                render();
            } else {
                const mysteries = [
                    "The samurai watches in silence; nothing happens.",
                    "The geometric alignment is off; the spirits do not answer."
                ];
                alert(mysteries[Math.floor(Math.random() * mysteries.length)]);
            }
        };
    }

    function renderChemistry(c) {
        state.discovered.push('door6');
        if(state.solved.includes('chem')) { c.innerHTML = `<h2>CHEMISTRY</h2><div class="solved-text">F</div><button onclick="goTo('hallway')">Return</button>`; return; }
        c.innerHTML = `<h2>CHEMISTRY</h2><div id="b1" class="beaker"></div><div id="b2" class="beaker"></div><br>
        <button onclick="mix('red')">RED</button><button onclick="mix('blue')">BLUE</button><button onclick="mix('yellow')">YELLOW</button><button onclick="mix('white')">WHITE</button>
        <br><button onclick="checkChem()">SUBMIT</button><button onclick="state.beakers=[];render();">RESET</button><br><button onclick="goTo('hallway')">Return</button>`;
        let current = [];
        window.mix = (col) => {
            current.push(col);
            if(current.length === 2) {
                const s = current.sort().join('');
                let res = 'gray';
                if(s === 'bluered') res = 'purple';
                if(s === 'redyellow') res = 'orange';
                state.beakers.push(res);
                current = [];
                render();
            }
        };
        if(state.beakers[0]) document.getElementById('b1').style.background = state.beakers[0];
        if(state.beakers[1]) document.getElementById('b2').style.background = state.beakers[1];
        window.checkChem = () => {
            if(state.beakers[0] === 'purple' && state.beakers[1] === 'orange') { state.solved.push('chem'); render(); }
            else { alert("Fizzle..."); state.beakers=[]; render(); }
        };
    }

    function renderStatueRoom(c) {
        state.discovered.push('door7');
        if(state.solved.includes('statue')) { c.innerHTML = `<h2>STATUE ROOM</h2><div class="solved-text">K</div><button onclick="goTo('hallway')">Return</button>`; return; }
        c.innerHTML = `<h2>STATUE ROOM</h2><div class="statue-grid">${state.statues.map((r,i)=>`<div onclick="state.statues[${i}]=(state.statues[${i}]+90)%360;render()" class="muse" style="transform:rotate(${r}deg)">ðŸ—½</div>`).join('')}</div><button onclick="checkStat()">SUBMIT</button><br><button onclick="goTo('hallway')">Return</button>`;
        window.checkStat = () => {
            if(state.statues[0]===180 && state.statues[1]===0 && state.statues[2]===90 && state.statues[3]===0) { state.solved.push('statue'); render(); }
            else alert("Cold.");
        };
    }

    loadProgress();
    render();
</script>
</body>
</html>