<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HALSEY: THE ESCAPE</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --accent: #8e44ad;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
            overflow: hidden;
        }

        #game-container {
            width: 90%;
            max-width: 650px;
            padding: 40px;
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            background: #0d0d0d;
        }

        /* Inventory UI */
        #inventory-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        .inv-item {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: #1a1a1a;
            font-size: 1.2rem;
        }
        .inv-item:hover { border-color: var(--accent); }

        /* Modal for Cipher */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #modal img { max-width: 80%; border: 2px solid var(--accent); }

        button {
            background: transparent;
            color: var(--text-color);
            border: 1px solid var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 10px;
            transition: 0.3s;
        }
        button:hover { background: var(--text-color); color: var(--bg-color); }
        button:disabled { border-color: #333; color: #333; cursor: not-allowed; }

        input {
            background: #1a1a1a;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            margin: 5px;
            text-align: center;
        }

        .solved-text { color: var(--accent); font-weight: bold; font-size: 2.5em; margin: 10px 0; }
        .beaker { display: inline-block; width: 40px; height: 60px; border: 2px solid #ccc; border-top: none; border-radius: 0 0 8px 8px; margin: 5px; }
        .statue-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .muse { cursor: pointer; transition: transform 0.3s; font-size: 2rem; }
        .darkness { background: black; color: #222; padding: 50px; }
    </style>
</head>
<body>

<audio id="bg-music" loop>
    <source src="assets/castle_instrumental.mp3" type="audio/mpeg">
    Your browser does not support the audio element.
</audio>

<div id="modal" onclick="this.style.display='none'">
    <div style="text-align:center;">
        <img src="https://via.placeholder.com/400x400?text=CAESAR+CIPHER+IMAGE" alt="Cipher">
        <p style="font-size:0.8em;">(Click anywhere to close)</p>
    </div>
</div>

<div id="game-container">
    <div id="inventory-bar"></div>
    <div id="content"></div>
</div>

<script>
    let state = {
        currentPage: 'home',
        introStep: 0,
        discovered: ['door5'],
        solved: [], 
        inventory: [], // 'matches', 'cipher', 'key'
        chamberUnlocked: false,
        torchesLit: false,
        statues: [0, 0, 0, 0],
        beakers: []
    };

    window.startExperience = () => {
        const music = document.getElementById('bg-music');
        
        // Attempt to play music
        music.play().catch(error => {
            console.log("Autoplay prevented. Music will start after next interaction.");
        });

        // Reset intro step and go to intro
        state.introStep = 0; 
        goTo('intro');
    };

    // --- Persistence ---
    const loadProgress = () => {
        const saved = localStorage.getItem('halsey_escape_v2');
        if (saved) state = JSON.parse(saved);
    };
    const save = () => {
        // Logic check: If Door 3, 4, 6, 7 are solved, grant the key automatically
        const required = ['library', 'game', 'chem', 'statue'];
        const hasAll = required.every(r => state.solved.includes(r));
        if (hasAll && !state.inventory.includes('key')) {
            state.inventory.push('key');
            alert("A metallic clink echoes behind you. A key has fallen from a hidden wall compartment -- you quickly snatch it up");
        }
        localStorage.setItem('halsey_escape_v2', JSON.stringify(state));
        updateInventoryUI();
    };

    const resetGame = () => {
        if(confirm("Are you sure you want to reset all progress?")) {
            localStorage.removeItem('halsey_escape_v2');
            location.reload();
        }
    };

    // --- Inventory UI ---
    const updateInventoryUI = () => {
        const bar = document.getElementById('inventory-bar');
        bar.innerHTML = '';
        state.inventory.forEach(item => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            if(item === 'matches') { div.innerText = 'üî•'; div.onclick = () => alert("A box of wooden matches."); }
            if(item === 'cipher') { div.innerText = 'üìú'; div.onclick = () => document.getElementById('modal').style.display='flex'; }
            if(item === 'key') { div.innerText = 'üîë'; div.onclick = () => alert("The Master Key to the Old Man's Chambers."); }
            bar.appendChild(div);
        });
    };

    // --- Navigation ---
    const goTo = (pg) => { state.currentPage = pg; render(); };

    function render() {
        const content = document.getElementById('content');
        content.innerHTML = '';
        window.onkeydown = null; // Clean up listeners

switch(state.currentPage) {
            case 'home':
                content.innerHTML = `
                    <h1>BADLANDS</h1>
                    <p>Escape the Old Man's Castle</p>
                    <button onclick="startExperience()">Begin</button>`;
                break;
            case 'intro':
                renderIntro(content);
                break;
            case 'hallway':
                renderHallway(content);
                break;
            case 'cell':
                renderCell(content);
                break;
            case 'door1':
                renderDoor1(content);
                break;
            case 'door2':
                renderDoor2(content);
                break;
            case 'door3':
                renderLibrary(content);
                break;
            case 'door4':
                renderGameRoom(content);
                break;
            case 'door6':
                renderChemistry(content);
                break;
            case 'door7':
                renderStatueRoom(content);
                break;
            case 'door8':
                renderSupplyCloset(content);
                break;
        }
        save();
    }

    // --- Page Logic Functions ---

function renderHallway(container) {
        // Define the specific layout positions
        const topDoor = { id: 'door1', name: 'Main Door' };
        const bottomDoor = { id: 'door5', name: 'Cell' };
        
        // Split the remaining 6 doors into left and right wings
        const leftWing = [
            { id: 'door2', name: "Old Man's Chambers" },
            { id: 'door3', name: 'Library' },
            { id: 'door4', name: 'Game Room' }
        ];
        const rightWing = [
            { id: 'door6', name: 'Chemistry Room' },
            { id: 'door7', name: 'Statue Room' },
            { id: 'door8', name: 'Supply Closet' }
        ];

        container.innerHTML = `
            <h2>THE GREAT HALLWAY</h2>
            <p style="font-style: italic; color: #888; margin-bottom: 30px;">The corridor stretches out, dimly lit by flickering torches.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; align-items: center; max-width: 800px; margin: 0 auto;">
                
                <div style="grid-column: 2; padding: 10px; border-radius: 4px;">
                    ${renderDoorLink(topDoor)}
                </div>

                <div style="grid-column: 1; grid-row: 2 / 5; display: flex; flex-direction: column; gap: 40px; text-align: right;">
                    ${leftWing.map(d => renderDoorLink(d)).join('')}
                </div>

                <div style="grid-column: 3; grid-row: 2 / 5; display: flex; flex-direction: column; gap: 40px; text-align: left;">
                    ${rightWing.map(d => renderDoorLink(d)).join('')}
                </div>

                <div style="grid-column: 2; grid-row: 5; padding: 10px; border-radius: 4px;">
                    ${renderDoorLink(bottomDoor)}
                </div>

            </div>

            <br>
            <button onclick="resetGame()" style="font-size:0.6em; margin-top:50px; opacity: 0.5;">Restart Game</button>
        `;

        // Helper function to handle discovery logic and labels
        function renderDoorLink(d) {
            const isDiscovered = state.discovered.includes(d.id) || d.id === 'door5';
            const label = isDiscovered ? d.name.toUpperCase() : "DOOR";
            const target = d.id === 'door1' ? 'door1' : (d.id === 'door5' ? 'cell' : d.id);
            
            return `
                <p style="margin: 0;">
                    <a href="#" 
                       style="color: ${isDiscovered ? 'white' : '#555'}; text-decoration: none; font-weight: bold; letter-spacing: 1px;" 
                       onclick="goTo('${target}')">
                       ${label}
                    </a>
                </p>`;
        }
    }

function renderCell(container) {
        state.discovered.push('door5');
        
        if (state.solved.includes('cell')) {
            container.innerHTML = `
                <h2>THE CELL</h2>
                <div class="solved-text">P</div>
                <p>The iron bars open! As you tiptoe out of the room, you notice the strange lock displays a letter.</p>
                <button onclick="goTo('hallway')">Go to Hallway</button>`;
            return;
        }

        let inputs = [];
        container.innerHTML = `
            <h2>THE CELL</h2>
            <p>As the guard marches back out of the hall, you take a moment to take in your new surroundings. Ther cell is damp and clammy and you wish you brought a sweater. But you realize there's no time to feel cold! You have to figure out how to get out of here and back to your people!</p>
            <p>There doesn't seem to be much in the cell that can help you. Luckily, as the guard was dragging you down the hallway, you managed to sneak a crumpled scrap of paper out of his pocket./p>
            
            <pre style="font-size:0.8rem; background:#111; padding: 15px; border-radius: 8px; border: 1px solid #333; display: inline-block; text-align: left; line-height: 1.4; color: #aaa;">
1. Castle
2. "Hold Me ____"
3. "New Americana"
4. "Drive"
4. "Drive"
6. "Colors"
7. "Coming ____"
8. "Haunting"
9. "_______"
10. "Young God"
11. "Ghost"</pre>

            <p style="margin-top: 20px;">The lock on the door is not typical. It seems to respond to a wide range of inputs...</p>
            <div id="cd" style="height:40px; border-bottom: 2px solid var(--md-primary); margin:20px auto; width: 80%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; color: var(--md-primary); font-weight: bold; letter-spacing: 3px;"></div>
            
            <button onclick="checkCell()">SUBMIT</button>
            <button class="secondary" onclick="goTo('cell')">RESET</button>`;

        // Capture keyboard events
        window.onkeydown = (e) => { 
            // Prevent scrolling with arrows while playing
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
                e.preventDefault();
            }

            let displayChar = e.key;
            if (e.key === "ArrowDown") displayChar = "‚Üì";
            if (e.key === "Control") displayChar = "CTRL";
            if (e.key === "ArrowUp") displayChar = "‚Üë";
            if (e.key === "ArrowLeft") displayChar = "‚Üê";
            if (e.key === "ArrowRight") displayChar = "‚Üí";

            inputs.push(e.key); 
            document.getElementById('cd').innerText = inputs.slice(-10).join(' '); // Show last 10 inputs
        };

        window.checkCell = () => {
            // Check the last 3 inputs for Down, Down, Control
            const secret = inputs.slice(-3).join(',');
            if (secret === "ArrowDown,ArrowDown,Control") { 
                state.solved.push('cell'); 
                render(); 
            } else { 
                alert("The lock pulses with a cold, red light. Nothing happens."); 
                inputs = []; 
                document.getElementById('cd').innerText = "";
            }
        };
    }

function renderSupplyCloset(container) {
        state.discovered.push('door8');

        // Check if the player already has the item
        if (state.inventory.includes('matches')) {
            container.innerHTML = `
                <h2>SUPPLY CLOSET</h2>
                <p>The narrow room is quiet now, smelling of cedar and old floor wax. The shelf where the matches sat is now empty.</p>
                <button onclick="goTo('hallway')">Return to Hallway</button>`;
            return;
        }

        // Render the unsolved state
        container.innerHTML = `
            <h2>SUPPLY CLOSET</h2>
            <p>This cramped space is packed with cleaning supplies and forgotten linens. Tucked behind a heavy bucket, you find a box of matches, but it is stuck.</p>
            
            <div style="margin: 20px 0;">
                <img src="assets/matches.png" alt="Matchstick Puzzle" style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--md-outline);">
            </div>

            <p>There is at least one number above 50000 you can make by moving two matches. What is one of those numbers?</p>
            
            <input id="sc-in" type="number" placeholder="Enter the number">
            <br>
            <button onclick="checkSC()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;

        // Puzzle logic
        window.checkSC = () => {
            const val = document.getElementById('sc-in').value;
            // Accepts both 51181 and 81151 based on your requirements
            if(val === '51181' || val === '81151') {
                state.inventory.push('matches');
                alert("THe box of matches become unstuck, so you take it. Might come in handy later.");
                render(); // Re-render to show the "taken" state
            } else { 
                alert("The matchbox remains stuck. Maybe that's not the right number."); 
            }
        };
    }

function renderLibrary(container) {
        state.discovered.push('door3');
        
        // Handling the dark state
        if (!state.torchesLit) {
            container.innerHTML = `
                <div class="darkness">It is pitch black. You can see the faint outline of torches on the wall.</div>
                ${state.inventory.includes('matches') ? 
                    '<button onclick="state.torchesLit=true; render();">Light Torches</button>' : 
                    '<p>If only you had a way to light them...</p>'}
                <button onclick="goTo('hallway')">Leave</button>`;
            return;
        }

        // Handling the solved state
        if (state.solved.includes('library')) {
            container.innerHTML = `
                <h2>LIBRARY</h2>
                <div class="solved-text">DD</div>
                <p>You wait, then out of nowhere, ink magically write to the page. It shows two letter.</p>
                <button onclick="goTo('hallway')">Return to Hallway</button>`;
            return;
        }

        // Main Puzzle State
        container.innerHTML = `
            <h2>LIBRARY</h2>
            <p>This is the Old Man's record keeping room, with hundreds of old books and logs. On his mahogany table sits an incomplete record:</p>
            
            <div style="display: flex; justify-content: space-around; align-items: flex-start; gap: 10px; margin-top: 20px;">
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                    <img src="assets/date1.png" style="width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 4px; border: 1px solid var(--md-outline); margin-bottom: 10px;">
                    <input id="l1" placeholder="MM/DD" style="width: 90%; font-size: 0.9rem;">
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                    <img src="assets/date2.png" style="width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 4px; border: 1px solid var(--md-outline); margin-bottom: 10px;">
                    <input id="l2" placeholder="MM/DD" style="width: 90%; font-size: 0.9rem;">
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                    <img src="assets/date3.png" style="width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 4px; border: 1px solid var(--md-outline); margin-bottom: 10px;">
                    <input id="l3" placeholder="MM/DD" style="width: 90%; font-size: 0.9rem;">
                </div>
            </div>

            <br>
            <button onclick="checkLib()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;

        window.checkLib = () => {
            const d1 = document.getElementById('l1').value;
            const d2 = document.getElementById('l2').value;
            const d3 = document.getElementById('l3').value;

            if(d1 === '1223' && d2 === '0110' && d3 === '0131') {
                state.solved.push('library'); 
                render();
            } else {
                alert("You wait in silence, but nothing appears to have happened.");
            }
        };
    }

    function renderIntro(container) {
        // Part 1: The Rebellion
        if (state.introStep === 0) {
            container.innerHTML = `
                <h2>THE RISE</h2>
                <p>Since the Old Man's reign began, the Badlands have never been the same. Many have tried before you to overthrow him, but each one of those movements struggled due to sabotage and infighting, and were ultimately handily crushed by the Old Man's regime.</p>
                <p>That is, until you came along. You are the bright new leader of a new rebel cause, one more powerful than any before it. The people of the Badlands rally behind you, united like they never have been before, calling you their <strong>Queen</strong>.</p>
                <p>The Old Man, of course, would not stand for this. The moment he heard murmurs of your movement, he demanded his army to search for you, night and day. You manage to evade their search for weeks, working on organizing an attack on Old Man‚Äôs castle like never attempted before. However on the eve of the operation, you find yourself surrounded by the Old Man's soldiers.</p>
                <p>Before you can even think about running, a sweet smelling cloth is held forcefully against your face. In an instant, you blank.</p>
                <button onclick="state.introStep = 1; render();">Next</button>
            `;
        } 
        // Part 2: The Capture
        else {
            container.innerHTML = `
                <h2>THE CAPTURE</h2>
                <p>You awake to armored hands, clamping around your arms like iron. They drag you through torch-lit corridors reeking of old stone and iron, your boots scraping defiance against the floor. Ahead, the throne room doors groan open just enough to reveal him: <strong>the Old Man</strong>, enthroned in shadow on black marble steps.</p>
                <p>You shout at him in defiance.</p>
                <blockquote style="font-style: italic; color: #8e44ad; border-left: 3px solid #8e44ad; padding-left: 15px; margin: 20px 0; text-align: left;">
                    "Hmph! We finally meet and that‚Äôs how you greet me? That's exactly why you're in this mess in the first place. You probably should have kept your pretty mouth shut."
                </blockquote>
                <p>He leans forward, staring you down menacingly. Without breaking eye contact with you he says, ‚Äútake her upstairs. To the cell in my chambers. I‚Äôll deal with her myself‚Ä¶ later.‚Äù</p>
                <p>Before you can protest, the guards yank you back up, hauling you up winding stairs past barred windows. A heavy iron door crashes open. You‚Äôre thrown inside.</p>
                <p><strong>You are in the tower cell of the Old Man‚Äôs Castle.</strong></p>
                <button onclick="goTo('cell')">Start Escape</button>
            `;
        }
    }

    function renderDoor2(container) {
        state.discovered.push('door2');

        // State 1: Door is Locked
        if(!state.chamberUnlocked) {
            container.innerHTML = `
                <h2>OLD MAN'S CHAMBERS</h2>
                
                <p>The heavy oak door is reinforced with iron bands. A curious, ornate keyhole is set into the wall beside the frame.</p>
                
                <div style="margin: 30px 0;">
                    <img src="assets/keyhole.png" alt="Ornate Keyhole" style="width: 160px; height: auto; filter: drop-shadow(0px 6px 8px rgba(0,0,0,0.6));">
                </div>

                ${state.inventory.includes('key') ? 
                    '<button onclick="state.chamberUnlocked=true; render();">Use Key</button>' : 
                    '<p>The door is locked tight. It seems you will need a specific key to gain entry to his private quarters.</p>'}
                
                <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;
            return;
        } 

        // State 2: Inside the Chambers
        container.innerHTML = `
            <h2>INSIDE CHAMBERS</h2>
            <p>The room is dimly lit, smelling of old leather and expensive tobacco. You quickly begin rummaging through the clutter of a lifetime of secrets. On his mahogany desk, you find the Old Man's diary. A single page is marked: <strong>"In case of emergency."</strong></p>
            
            <div style="margin: 20px 0;">
                <img src="assets/google-photos.jpg" alt="Emergency Cipher" style="max-width: 100%; height: auto; border-radius: 8px; border: 2px solid var(--md-outline); box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
            </div>

            <p>It's a familiar symbol...</p>
            
            <button onclick="goTo('hallway')">Return to Hallway</button>`;
    }

function renderDoor1(container) {
        state.discovered.push('door1');

        // Main Door - Locked View
        container.innerHTML = `
            <div class="final-gate">
                <h2>THE MAIN DOOR</h2>
                <div style="margin: 20px 0;">
                    <img src="assets/main_door.jpg" alt="The Great Exit" style="width: 100%; max-width: 500px; border-radius: 8px; border: 3px solid #444; box-shadow: 0 0 20px rgba(0,0,0,0.8);">
                </div>
                
                <p>The path to freedom is sealed by a massive stone gate. It feels like it's waiting for a specific word.</p>
                
                <div style="margin: 20px 0;">
                    <input id="final" placeholder="ENTER CODE" style="text-align: center; font-size: 1.2rem; padding: 10px; width: 200px; background: #000; color: #0f0; border: 1px solid #333;">
                </div>

                <button onclick="checkFinal()" style="background: var(--md-primary); color: white; padding: 10px 30px;">ESCAPE</button>
                <br>
                <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>
            </div>
        `;

        window.checkFinal = () => {
            const input = document.getElementById('final').value.toUpperCase().trim();
            
if(input === 'MATCHA') {
        // Victory Sequence
            container.innerHTML = `
                    <div style="background: #000; width: 100%; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
                        
                        <h1 style="color: gold; margin-bottom: 20px; font-size: 3rem; text-shadow: 0 0 10px rgba(255,215,0,0.5); animation: fadeIn 1.5s ease-out forwards;">
                            YOU ARE FREE!
                        </h1>

                        <img src="assets/main_door_opens.gif" alt="The Great Exit" style="width: 100%; max-width: 500px; border-radius: 8px; border: 3px solid #444; box-shadow: 0 0 20px rgba(255,215,0,0.4);">
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <a href="https://will-you-b-my-valentine.vercel.app" target="_blank" style="color: #00ff00; text-decoration: underline; font-family: monospace; font-size: 1.4rem; display: block; animation: fadeIn 3s ease-out forwards;">
                                (open me)
                            </a>
                        </div>

                        <button onclick="resetGame()" style="margin-top: 50px; background: transparent; border: 1px solid #333; color: #555; font-size: 0.7rem; cursor: pointer; animation: fadeIn 5s ease-out forwards;">
                            Restart Game
                        </button>

                        <style>
                            @keyframes fadeIn {
                                from { opacity: 0; transform: translateY(5px); }
                                to { opacity: 1; transform: translateY(0); }
                            }
                        </style>
                    </div>
                `;
            } else {
                alert("The padlock prevents you from opening the heavy doors.");
            }
        };
    }

function renderGameRoom(c) {
        state.discovered.push('door4');
        if(state.solved.includes('game')) { 
            c.innerHTML = `
                <h2>GAME ROOM</h2>
                <div class="solved-text">W</div>
                <p>You calculate the scores and dole out the token to each side. Magically, all the cards begin to rearrange by themselves, into a shape of... a letter.</p>
                <button onclick="goTo('hallway')">Return to Hallway</button>
                <style>
                    @keyframes cardGlow {
                        from { color: #fff; text-shadow: 0 0 10px #3498db; }
                        to { color: #3498db; text-shadow: 0 0 20px #fff; }
                    }
                </style>`; 
            return; 
        }
        
        c.innerHTML = `
            <h2>GAME ROOM</h2>
            <p>A chill hangs in the air of this enchanted parlor, filled with interesting knicknacks and games. In the center of the room, a legendary board game sits atop a pedestal, its pieces seemingly moving on their own as if waiting for something.</p>
            
            <div style="margin-bottom: 20px;">
                <img src="assets/samurai-edited.png" alt="Samurai" style="max-width: 100%; height: auto; border-radius: 12px; border: 1px solid var(--md-outline);">
            </div>
            
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
                <svg width="45" height="45" viewBox="0 0 100 100">
                    <rect x="15" y="15" width="70" height="70" fill="#2196f3" />
                </svg>

                <svg width="45" height="45" viewBox="0 0 100 100" 
                     style="cursor: pointer;" 
                     onclick="window.open('https://wyrmbergames.wordpress.com/the-games-n-z/samurai-the-card-game/#:~:text=Victory%20Conditions,winning%20markers%2C%20wins.', '_blank')">
                    <circle cx="50" cy="50" r="40" fill="#f44336" />
                </svg>

                <svg width="45" height="45" viewBox="0 0 100 100">
                    <polygon points="50,15 90,85 10,85" fill="#8e44ad" />
                </svg>
            </div>

            <input id="gi" type="number" placeholder="Enter Code">
            <br>
            <button onclick="checkGameMove()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>
        `;

        window.checkGameMove = () => {
            const val = document.getElementById('gi').value;
            if(val === '102') {
                state.solved.push('game');
                render();
            } else {
                const mysteries = [
                    "The samurai watches in silence; nothing happens.",
                    "The geometric alignment is off; the spirits do not answer."
                ];
                alert(mysteries[Math.floor(Math.random() * mysteries.length)]);
            }
        };
    }

function renderChemistry(c) {
        state.discovered.push('door6');
        
if(state.solved.includes('chem')) { 
            c.innerHTML = `
                <h2>CHEMISTRY</h2>
                <div class="solved-text" style="animation: glow 2s infinite alternate;">F</div>
                <p>As the purple and orange liquids settle, a precipitate forms. It appears to form a letter...</p>
                <button onclick="goTo('hallway')">Return to Hallway</button>
                <style>
                    @keyframes glow {
                        from { text-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px var(--md-primary); }
                        to { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px var(--md-primary); }
                    }
                </style>`; 
            return; 
        }

        c.innerHTML = `
            <h2>CHEMISTRY</h2>
            <p>The Old Man's laboratory. A weird smell fills the air, which you realize you probably should breathe in for too long...</p>
            
            <div class="beaker-container" style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                <div id="b1" class="beaker" style="cursor: pointer;" onclick="openChemModal('assets/purple.png')"></div>
                <div id="b2" class="beaker" style="cursor: pointer;" onclick="openChemModal('assets/orange.jpg')"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <button onclick="mix('red')" style="background:#f44336; color:white; border:none;">RED</button>
                <button onclick="mix('blue')" style="background:#2196f3; color:white; border:none;">BLUE</button>
                <button onclick="mix('yellow')" style="background:#ffeb3b; color:black; border:none;">YELLOW</button>
                <button onclick="mix('white')" style="background:#ffffff; color:black; border:none; border: 1px solid #ccc;">WHITE</button>
            </div>

            <button onclick="checkChem()">SUBMIT</button>
            <button class="secondary" onclick="state.beakers=[];render();">RESET</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;

        let current = [];
        window.mix = (col) => {
            if (state.beakers.length >= 2) return; 
            current.push(col);
            
            if(current.length === 2) {
                const s = current.sort().join('');
                let res = 'gray';

                // --- Comprehensive Mixology Logic ---
                
                // Self-Mixing
                if (s === 'redred') res = 'red';
                else if (s === 'blueblue') res = 'blue';
                else if (s === 'yellowyellow') res = 'yellow';
                else if (s === 'whitewhite') res = 'white';

                // Primary + Primary (Secondary Colors)
                else if (s === 'bluered') res = 'purple';
                else if (s === 'redyellow') res = 'orange';
                else if (s === 'blueyellow') res = 'green';

                // Color + White (Tints)
                else if (s === 'redwhite') res = 'pink';
                else if (s === 'bluewhite') res = 'skyblue';
                else if (s === 'whiteyellow') res = '#fff9c4'; // Lighter yellow

                state.beakers.push(res);
                current = [];
                render();
            }
        };

        // Render filled beakers
        if(state.beakers[0]) document.getElementById('b1').style.background = state.beakers[0];
        if(state.beakers[1]) document.getElementById('b2').style.background = state.beakers[1];

        window.checkChem = () => {
            if(state.beakers[0] === 'purple' && state.beakers[1] === 'orange') { 
                state.solved.push('chem'); 
                render(); 
            } else { 
                alert("The mixture boils over into a dark sludge. Start again."); 
                state.beakers = []; 
                render(); 
            }
        };

        window.openChemModal = (src) => {
            const modal = document.getElementById('modal');
            const modalImg = modal.querySelector('img');
            modalImg.src = src;
            modal.style.display = 'grid';
        };
    }

function renderStatueRoom(c) {
        state.discovered.push('door7');
        
        if(state.solved.includes('statue')) { 
            c.innerHTML = `<h2>STATUE ROOM</h2><div class="solved-text">K</div><p>Lonely is the muse.</p><button onclick="goTo('hallway')">Return</button>`; 
            return; 
        }

        // Configuration of men for each statue (N, S, E, W)
        const menConfig = [
            ['S', 'E', 'W'], // Only North is safe
            ['N', 'E', 'W'], // Only South is safe
            ['N', 'S', 'E'], // Only West is safe
            ['N', 'E']       // North and East are blocked; South and West are safe
        ];

        c.innerHTML = `
            <h2>STATUE ROOM</h2>
            <p>In each corner of the room, there is a female statue, surrounded by male statues. It almost like is a muse, surrounded by the stony gaze of her onlookers.</p>
            <div class="statue-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 60px; justify-items: center; margin: 40px auto; max-width: 700px;">
                ${state.statues.map((rotation, i) => `
                    <div class="statue-group" style="position: relative; width: 280px; height: 280px; background: rgba(255,255,255,0.01); border-radius: 50%;">
                        ${renderMen(menConfig[i])}
                        <img src="assets/muse.png" 
                             onclick="state.statues[${i}]=(state.statues[${i}]+90)%360; render();" 
                             style="position: absolute; top: 90px; left: 90px; width: 100px; transform: rotate(${rotation}deg); cursor: pointer; transition: transform 0.5s ease;">
                    </div>
                `).join('')}
            </div>
            <button onclick="checkStat()">SUBMIT</button>
            <button class="secondary" onclick="goTo('hallway')">Return</button>`;

        function renderMen(list) {
            const p = { N: "top:-20px;left:110px", S: "bottom:-20px;left:110px", W: "top:110px;left:-20px", E: "top:110px;right:-20px" };
            return list.map(dir => `<img src="assets/man.png" style="position:absolute; width:60px; ${p[dir]}; filter:grayscale(100%); opacity:0.7;">`).join('');
        }

        window.checkStat = () => {
            const isSafe = state.statues.every((rotation, i) => {
                // Map rotation to the direction the Muse is facing
                // 0=South, 90=West, 180=North, 270=East
                const facing = { 0: 'S', 90: 'W', 180: 'N', 270: 'E' }[rotation];
                // She is safe if her 'facing' direction has NO man
                return !menConfig[i].includes(facing);
            });

            if (isSafe) {
                state.solved.push('statue');
                render();
            } else {
                alert("You could swear you heard a muse statue sigh...");
            }
        };
    }
    loadProgress();
    render();
</script>
</body>
</html>