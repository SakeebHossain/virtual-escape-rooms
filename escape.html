<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HALSEY: THE ESCAPE</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --text-color: #e0e0e0;
            --accent: #8e44ad;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
            overflow: hidden;
        }

        #game-container {
            width: 90%;
            max-width: 650px;
            padding: 40px;
            border: 1px solid var(--border);
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            position: relative;
            background: #0d0d0d;
        }

        /* Inventory UI */
        #inventory-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }
        .inv-item {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            background: #1a1a1a;
            font-size: 1.2rem;
        }
        .inv-item:hover { border-color: var(--accent); }

        /* Modal for Cipher */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #modal img { max-width: 80%; border: 2px solid var(--accent); }

        button {
            background: transparent;
            color: var(--text-color);
            border: 1px solid var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 10px;
            transition: 0.3s;
        }
        button:hover { background: var(--text-color); color: var(--bg-color); }
        button:disabled { border-color: #333; color: #333; cursor: not-allowed; }

        input {
            background: #1a1a1a;
            border: 1px solid var(--border);
            color: white;
            padding: 10px;
            margin: 5px;
            text-align: center;
        }

        .solved-text { color: var(--accent); font-weight: bold; font-size: 2.5em; margin: 10px 0; }
        .beaker { display: inline-block; width: 40px; height: 60px; border: 2px solid #ccc; border-top: none; border-radius: 0 0 8px 8px; margin: 5px; }
        .statue-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .muse { cursor: pointer; transition: transform 0.3s; font-size: 2rem; }
        .darkness { background: black; color: #222; padding: 50px; }
    </style>
</head>
<body>



<div id="modal" onclick="this.style.display='none'">
    <div style="text-align:center;">
        <img src="https://via.placeholder.com/400x400?text=CAESAR+CIPHER+IMAGE" alt="Cipher">
        <p style="font-size:0.8em;">(Click anywhere to close)</p>
    </div>
</div>

<div id="game-container">
    <div id="inventory-bar"></div>
    <div id="content"></div>
</div>

<script>
    let state = {
        currentPage: 'home',
        discovered: ['door5'],
        solved: [], 
        inventory: [], // 'matches', 'cipher', 'key'
        chamberUnlocked: false,
        torchesLit: false,
        statues: [0, 0, 0, 0],
        beakers: []
    };

    // --- Persistence ---
    const loadProgress = () => {
        const saved = localStorage.getItem('halsey_escape_v2');
        if (saved) state = JSON.parse(saved);
    };
    const save = () => {
        // Logic check: If Door 3, 4, 6, 7 are solved, grant the key automatically
        const required = ['library', 'game', 'chem', 'statue'];
        const hasAll = required.every(r => state.solved.includes(r));
        if (hasAll && !state.inventory.includes('key')) {
            state.inventory.push('key');
            alert("With the four rooms complete, a golden key materializes in your hand!");
        }
        localStorage.setItem('halsey_escape_v2', JSON.stringify(state));
        updateInventoryUI();
    };

    const resetGame = () => {
        if(confirm("Are you sure you want to reset all progress?")) {
            localStorage.removeItem('halsey_escape_v2');
            location.reload();
        }
    };

    // --- Inventory UI ---
    const updateInventoryUI = () => {
        const bar = document.getElementById('inventory-bar');
        bar.innerHTML = '';
        state.inventory.forEach(item => {
            const div = document.createElement('div');
            div.className = 'inv-item';
            if(item === 'matches') { div.innerText = 'ðŸ”¥'; div.onclick = () => alert("A box of wooden matches."); }
            if(item === 'cipher') { div.innerText = 'ðŸ“œ'; div.onclick = () => document.getElementById('modal').style.display='flex'; }
            if(item === 'key') { div.innerText = 'ðŸ”‘'; div.onclick = () => alert("The Master Key to the Old Man's Chambers."); }
            bar.appendChild(div);
        });
    };

    // --- Navigation ---
    const goTo = (pg) => { state.currentPage = pg; render(); };

    function render() {
        const content = document.getElementById('content');
        content.innerHTML = '';
        window.onkeydown = null; // Clean up listeners

        switch(state.currentPage) {
            case 'home':
                content.innerHTML = `<h1>HALSEY</h1><p>Escape the Old Man's Castle</p><button onclick="goTo('intro')">Begin</button>`;
                break;
            case 'intro':
                content.innerHTML = `<h2>THE CAPTURE</h2><p>Taken to the high chambers... escape is the only option.</p><button onclick="goTo('cell')">Start</button>`;
                break;
            case 'hallway':
                renderHallway(content);
                break;
            case 'cell':
                renderCell(content);
                break;
            case 'door1':
                renderDoor1(content);
                break;
            case 'door2':
                renderDoor2(content);
                break;
            case 'door3':
                renderLibrary(content);
                break;
            case 'door4':
                renderGameRoom(content);
                break;
            case 'door6':
                renderChemistry(content);
                break;
            case 'door7':
                renderStatueRoom(content);
                break;
            case 'door8':
                renderSupplyCloset(content);
                break;
        }
        save();
    }

    // --- Page Logic Functions ---

    function renderHallway(container) {
        const doors = [
            { id: 'door1', name: 'Main Door' },
            { id: 'door2', name: "Old Man's Chambers" },
            { id: 'door3', name: 'Library' },
            { id: 'door4', name: 'Game Room' },
            { id: 'door5', name: 'Cell' },
            { id: 'door6', name: 'Chemistry Room' },
            { id: 'door7', name: 'Statue Room' },
            { id: 'door8', name: 'Supply Closet' }
        ];
        
        container.innerHTML = `<h2>THE HALLWAY</h2><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left;"></div><br><button onclick="resetGame()" style="font-size:0.6em; margin-top:50px;">Reset Progress</button>`;
        const grid = container.querySelector('div');
        
        doors.forEach(d => {
            const isDiscovered = state.discovered.includes(d.id) || d.id === 'door5';
            const label = isDiscovered ? `Door ${d.id.replace('door','')} (${d.name})` : `Door ${d.id.replace('door','')}`;
            const link = document.createElement('p');
            link.innerHTML = `<a href="#" style="color:white" onclick="goTo('${d.id === 'door5' ? 'cell' : d.id}')">${label}</a>`;
            grid.appendChild(link);
        });
    }

function renderCell(container) {
        state.discovered.push('door5');
        
        if (state.solved.includes('cell')) {
            container.innerHTML = `
                <h2>THE CELL</h2>
                <div class="solved-text">P</div>
                <p>The iron bars open! As you tiptoe out of the room, you notice the strange lock displays a letter.</p>
                <button onclick="goTo('hallway')">Go to Hallway</button>`;
            return;
        }

        let inputs = [];
        container.innerHTML = `
            <h2>THE CELL</h2>
            <p>As the guard marches back out of the hall, you take a moment to take in your new surroundings. Ther cell is damp and clammy and you wish you brought a sweater. But you realize there's no time to feel cold! You have to figure out how to get out of here and back to your people!</p>
            <p>There doesn't seem to be much in the cell that can help you. Luckily, as the guard was dragging you down the hallway, you managed to sneak a crumpled scrap of paper out of his pocket./p>
            
            <pre style="font-size:0.8rem; background:#111; padding: 15px; border-radius: 8px; border: 1px solid #333; display: inline-block; text-align: left; line-height: 1.4; color: #aaa;">
1. Castle
2. "Hold Me ____"
3. "New Americana"
4. "Drive"
4. "Drive"
6. "Colors"
7. "Coming ____"
8. "Haunting"
9. "_______"
10. "Young God"
11. "Ghost"</pre>

            <p style="margin-top: 20px;">The lock on the door is not typical. It seems to respond to a wide range of inputs...</p>
            <div id="cd" style="height:40px; border-bottom: 2px solid var(--md-primary); margin:20px auto; width: 80%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; color: var(--md-primary); font-weight: bold; letter-spacing: 3px;"></div>
            
            <button onclick="checkCell()">SUBMIT</button>
            <button class="secondary" onclick="goTo('cell')">RESET</button>`;

        // Capture keyboard events
        window.onkeydown = (e) => { 
            // Prevent scrolling with arrows while playing
            if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
                e.preventDefault();
            }

            let displayChar = e.key;
            if (e.key === "ArrowDown") displayChar = "â†“";
            if (e.key === "Control") displayChar = "CTRL";
            if (e.key === "ArrowUp") displayChar = "â†‘";
            if (e.key === "ArrowLeft") displayChar = "â†";
            if (e.key === "ArrowRight") displayChar = "â†’";

            inputs.push(e.key); 
            document.getElementById('cd').innerText = inputs.slice(-10).join(' '); // Show last 10 inputs
        };

        window.checkCell = () => {
            // Check the last 3 inputs for Down, Down, Control
            const secret = inputs.slice(-3).join(',');
            if (secret === "ArrowDown,ArrowDown,Control") { 
                state.solved.push('cell'); 
                render(); 
            } else { 
                alert("The lock pulses with a cold, red light. Nothing happens."); 
                inputs = []; 
                document.getElementById('cd').innerText = "";
            }
        };
    }

function renderSupplyCloset(container) {
        state.discovered.push('door8');

        // Check if the player already has the item
        if (state.inventory.includes('matches')) {
            container.innerHTML = `
                <h2>SUPPLY CLOSET</h2>
                <p>The narrow room is quiet now, smelling of cedar and old floor wax. The shelf where the matches sat is now empty.</p>
                <button onclick="goTo('hallway')">Return to Hallway</button>`;
            return;
        }

        // Render the unsolved state
        container.innerHTML = `
            <h2>SUPPLY CLOSET</h2>
            <p>This cramped space is packed with cleaning supplies and forgotten linens. Tucked behind a heavy bucket, you find a box of matches, but it is stuck.</p>
            
            <div style="margin: 20px 0;">
                <img src="images/matches.png" alt="Matchstick Puzzle" style="max-width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--md-outline);">
            </div>

            <p>There is at least one number above 50000 you can make by moving two matches. What is one of those numbers?</p>
            
            <input id="sc-in" type="number" placeholder="Enter the number">
            <br>
            <button onclick="checkSC()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;

        // Puzzle logic
        window.checkSC = () => {
            const val = document.getElementById('sc-in').value;
            // Accepts both 51181 and 81151 based on your requirements
            if(val === '51181' || val === '81151') {
                state.inventory.push('matches');
                alert("THe box of matches become unstuck, so you take it. Might come in handy later.");
                render(); // Re-render to show the "taken" state
            } else { 
                alert("The matchbox remains stuck. Maybe that's not the right number."); 
            }
        };
    }

function renderLibrary(container) {
        state.discovered.push('door3');
        
        // Handling the dark state
        if (!state.torchesLit) {
            container.innerHTML = `
                <div class="darkness">It is pitch black. You can see the faint outline of torches on the wall.</div>
                ${state.inventory.includes('matches') ? 
                    '<button onclick="state.torchesLit=true; render();">Light Torches</button>' : 
                    '<p>If only you had a way to light them...</p>'}
                <button onclick="goTo('hallway')">Leave</button>`;
            return;
        }

        // Handling the solved state
        if (state.solved.includes('library')) {
            container.innerHTML = `
                <h2>LIBRARY</h2>
                <div class="solved-text">DD</div>
                <p>You wait, then out of nowhere, ink magically write to the page. It shows two letter.</p>
                <button onclick="goTo('hallway')">Return to Hallway</button>`;
            return;
        }

        // Main Puzzle State
        container.innerHTML = `
            <h2>LIBRARY</h2>
            <p>This is the Old Man's record keeping room, with hundreds of old books and logs. On his mahogany table sits an incomplete record:</p>
            
            <div style="display: flex; justify-content: space-around; align-items: flex-start; gap: 10px; margin-top: 20px;">
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                    <img src="images/date1.png" style="width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 4px; border: 1px solid var(--md-outline); margin-bottom: 10px;">
                    <input id="l1" placeholder="MM/DD" style="width: 90%; font-size: 0.9rem;">
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                    <img src="images/date2.png" style="width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 4px; border: 1px solid var(--md-outline); margin-bottom: 10px;">
                    <input id="l2" placeholder="MM/DD" style="width: 90%; font-size: 0.9rem;">
                </div>
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                    <img src="images/date3.png" style="width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 4px; border: 1px solid var(--md-outline); margin-bottom: 10px;">
                    <input id="l3" placeholder="MM/DD" style="width: 90%; font-size: 0.9rem;">
                </div>
            </div>

            <br>
            <button onclick="checkLib()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;

        window.checkLib = () => {
            const d1 = document.getElementById('l1').value;
            const d2 = document.getElementById('l2').value;
            const d3 = document.getElementById('l3').value;

            if(d1 === '1223' && d2 === '0110' && d3 === '0131') {
                state.solved.push('library'); 
                render();
            } else {
                alert("You wait in silence, but nothing appears to have happened.");
            }
        };
    }

    function renderDoor2(container) {
        state.discovered.push('door2');
        if(!state.chamberUnlocked) {
            container.innerHTML = `<h2>OLD MAN'S CHAMBERS</h2><p>Locked keyhole.</p>${state.inventory.includes('key') ? '<button onclick="state.chamberUnlocked=true; render();">Use Golden Key</button>' : '<p>You need the Golden Key. Finish the other rooms.</p>'}<button onclick="goTo('hallway')">Return</button>`;
        } else {
            if(!state.inventory.includes('cipher')) state.inventory.push('cipher');
            container.innerHTML = `<h2>INSIDE CHAMBERS</h2><p>You rummage the desk and find the Caesar Cipher!</p><button onclick="goTo('hallway')">Return to Hallway</button>`;
        }
    }

    function renderDoor1(container) {
        state.discovered.push('door1');
        container.innerHTML = `<h2>MAIN DOOR</h2><input id="final" placeholder="CODE"><button onclick="checkFinal()">ESCAPE</button><br><button onclick="goTo('hallway')">Return to Hallway</button>`;
        window.checkFinal = () => {
            if(document.getElementById('final').value.toUpperCase() === 'MATCHA') {
                alert("THE DOOR SWINGS OPEN! YOU ARE FREE!");
                resetGame();
            } else alert("It won't budge.");
        };
    }

function renderGameRoom(c) {
        state.discovered.push('door4');
        if(state.solved.includes('game')) { 
            c.innerHTML = `<h2>GAME ROOM</h2><div class="solved-text">W</div><button onclick="goTo('hallway')">Return to Hallway</button>`; 
            return; 
        }
        
        c.innerHTML = `
            <h2>GAME ROOM</h2>
            <p>A chill hangs in the air of this enchanted parlor, filled with interesting knicknacks and games. In the center of the room, a legendary board game sits atop a pedestal, its pieces seemingly moving on their own as if waiting for something.</p>
            
            <div style="margin-bottom: 20px;">
                <img src="images/samurai-edited.png" alt="Samurai" style="max-width: 100%; height: auto; border-radius: 12px; border: 1px solid var(--md-outline);">
            </div>
            
            <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 20px;">
                <svg width="45" height="45" viewBox="0 0 100 100">
                    <rect x="15" y="15" width="70" height="70" fill="#2196f3" />
                </svg>

                <svg width="45" height="45" viewBox="0 0 100 100" 
                     style="cursor: pointer;" 
                     onclick="window.open('https://wyrmbergames.wordpress.com/the-games-n-z/samurai-the-card-game/#:~:text=Victory%20Conditions,winning%20markers%2C%20wins.', '_blank')">
                    <circle cx="50" cy="50" r="40" fill="#f44336" />
                </svg>

                <svg width="45" height="45" viewBox="0 0 100 100">
                    <polygon points="50,15 90,85 10,85" fill="#8e44ad" />
                </svg>
            </div>

            <input id="gi" type="number" placeholder="Enter Code">
            <br>
            <button onclick="checkGameMove()">SUBMIT</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>
        `;

        window.checkGameMove = () => {
            const val = document.getElementById('gi').value;
            if(val === '102') {
                state.solved.push('game');
                render();
            } else {
                const mysteries = [
                    "The samurai watches in silence; nothing happens.",
                    "The geometric alignment is off; the spirits do not answer."
                ];
                alert(mysteries[Math.floor(Math.random() * mysteries.length)]);
            }
        };
    }

function renderChemistry(c) {
        state.discovered.push('door6');
        
        if(state.solved.includes('chem')) { 
            c.innerHTML = `<h2>CHEMISTRY</h2><div class="solved-text">F</div><button onclick="goTo('hallway')">Return to Hallway</button>`; 
            return; 
        }

        c.innerHTML = `
            <h2>CHEMISTRY</h2>
            <p>The Old Man's laboratory. A weird smell fills the air, which you realize you probably should breathe in for too long...</p>
            
            <div class="beaker-container" style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                <div id="b1" class="beaker" style="cursor: pointer;" onclick="openChemModal('images/purple.png')"></div>
                <div id="b2" class="beaker" style="cursor: pointer;" onclick="openChemModal('images/orange.jpg')"></div>
            </div>

            <div style="margin-bottom: 20px;">
                <button onclick="mix('red')" style="background:#f44336; color:white; border:none;">RED</button>
                <button onclick="mix('blue')" style="background:#2196f3; color:white; border:none;">BLUE</button>
                <button onclick="mix('yellow')" style="background:#ffeb3b; color:black; border:none;">YELLOW</button>
                <button onclick="mix('white')" style="background:#ffffff; color:black; border:none; border: 1px solid #ccc;">WHITE</button>
            </div>

            <button onclick="checkChem()">SUBMIT</button>
            <button class="secondary" onclick="state.beakers=[];render();">RESET</button>
            <br>
            <button class="secondary" onclick="goTo('hallway')">Return to Hallway</button>`;

        let current = [];
        window.mix = (col) => {
            if (state.beakers.length >= 2) return; 
            current.push(col);
            
            if(current.length === 2) {
                const s = current.sort().join('');
                let res = 'gray';

                // --- Comprehensive Mixology Logic ---
                
                // Self-Mixing
                if (s === 'redred') res = 'red';
                else if (s === 'blueblue') res = 'blue';
                else if (s === 'yellowyellow') res = 'yellow';
                else if (s === 'whitewhite') res = 'white';

                // Primary + Primary (Secondary Colors)
                else if (s === 'bluered') res = 'purple';
                else if (s === 'redyellow') res = 'orange';
                else if (s === 'blueyellow') res = 'green';

                // Color + White (Tints)
                else if (s === 'redwhite') res = 'pink';
                else if (s === 'bluewhite') res = 'skyblue';
                else if (s === 'whiteyellow') res = '#fff9c4'; // Lighter yellow

                state.beakers.push(res);
                current = [];
                render();
            }
        };

        // Render filled beakers
        if(state.beakers[0]) document.getElementById('b1').style.background = state.beakers[0];
        if(state.beakers[1]) document.getElementById('b2').style.background = state.beakers[1];

        window.checkChem = () => {
            if(state.beakers[0] === 'purple' && state.beakers[1] === 'orange') { 
                state.solved.push('chem'); 
                render(); 
            } else { 
                alert("The mixture boils over into a dark sludge. Start again."); 
                state.beakers = []; 
                render(); 
            }
        };

        window.openChemModal = (src) => {
            const modal = document.getElementById('modal');
            const modalImg = modal.querySelector('img');
            modalImg.src = src;
            modal.style.display = 'grid';
        };
    }

function renderStatueRoom(c) {
        state.discovered.push('door7');
        
        if(state.solved.includes('statue')) { 
            c.innerHTML = `<h2>STATUE ROOM</h2><div class="solved-text">K</div><p>Lonely is the muse.</p><button onclick="goTo('hallway')">Return</button>`; 
            return; 
        }

        // Configuration of men for each statue (N, S, E, W)
        const menConfig = [
            ['S', 'E', 'W'], // Only North is safe
            ['N', 'E', 'W'], // Only South is safe
            ['N', 'S', 'E'], // Only West is safe
            ['N', 'E']       // North and East are blocked; South and West are safe
        ];

        c.innerHTML = `
            <h2>STATUE ROOM</h2>
            <p>In each corner of the room, there is a female statue, surrounded by male statues. It almost like is a muse, surrounded by the stony gaze of her onlookers.</p>
            <div class="statue-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 60px; justify-items: center; margin: 40px auto; max-width: 700px;">
                ${state.statues.map((rotation, i) => `
                    <div class="statue-group" style="position: relative; width: 280px; height: 280px; background: rgba(255,255,255,0.01); border-radius: 50%;">
                        ${renderMen(menConfig[i])}
                        <img src="images/muse.png" 
                             onclick="state.statues[${i}]=(state.statues[${i}]+90)%360; render();" 
                             style="position: absolute; top: 90px; left: 90px; width: 100px; transform: rotate(${rotation}deg); cursor: pointer; transition: transform 0.5s ease;">
                    </div>
                `).join('')}
            </div>
            <button onclick="checkStat()">SUBMIT</button>
            <button class="secondary" onclick="goTo('hallway')">Return</button>`;

        function renderMen(list) {
            const p = { N: "top:-20px;left:110px", S: "bottom:-20px;left:110px", W: "top:110px;left:-20px", E: "top:110px;right:-20px" };
            return list.map(dir => `<img src="images/man.png" style="position:absolute; width:60px; ${p[dir]}; filter:grayscale(100%); opacity:0.7;">`).join('');
        }

        window.checkStat = () => {
            const isSafe = state.statues.every((rotation, i) => {
                // Map rotation to the direction the Muse is facing
                // 0=South, 90=West, 180=North, 270=East
                const facing = { 0: 'S', 90: 'W', 180: 'N', 270: 'E' }[rotation];
                // She is safe if her 'facing' direction has NO man
                return !menConfig[i].includes(facing);
            });

            if (isSafe) {
                state.solved.push('statue');
                render();
            } else {
                alert("You could swear you heard a muse statue sigh...");
            }
        };
    }
    loadProgress();
    render();
</script>
</body>
</html>